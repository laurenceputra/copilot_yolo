name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  shellcheck:
    name: ShellCheck Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'
          severity: warning
          format: gcc
          additional_files: '.copilot_yolo.sh .copilot_yolo_entrypoint.sh .copilot_yolo_config.sh install.sh'

  test-install-script:
    name: Test Install Script
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      
      - name: Test Install Script (Dry Run)
        run: |
          # Create a temporary directory for test installation
          TEST_DIR=$(mktemp -d)
          
          # Test the install script by installing to temp dir
          COPILOT_YOLO_DIR="${TEST_DIR}/.copilot_yolo" \
          COPILOT_YOLO_PROFILE="${TEST_DIR}/.bashrc" \
          bash install.sh
          
          # Verify files were created
          ls -la "${TEST_DIR}/.copilot_yolo/"
          
          # Verify the env file was created
          test -f "${TEST_DIR}/.copilot_yolo/env"
          
          # Verify completion files
          test -f "${TEST_DIR}/.copilot_yolo/.copilot_yolo_completion.bash" || echo "Warning: bash completion not found"
          test -f "${TEST_DIR}/.copilot_yolo/.copilot_yolo_completion.zsh" || echo "Warning: zsh completion not found"
          
          # Clean up
          rm -rf "${TEST_DIR}"

  test-health-check:
    name: Test Health Check Command
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Health Check
        run: |
          # Test health check without building (should warn about missing image)
          COPILOT_SKIP_VERSION_CHECK=1 COPILOT_SKIP_UPDATE_CHECK=1 \
            ./.copilot_yolo.sh health || true

  test-config-generation:
    name: Test Config Generation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate Sample Config
        run: |
          set -e
          # Generate config in installation directory
          COPILOT_SKIP_UPDATE_CHECK=1 COPILOT_SKIP_VERSION_CHECK=1 \
            ./.copilot_yolo.sh config
          
          # Verify config was generated in the script directory
          if [ ! -f ./.copilot_yolo.conf ]; then
            echo "Error: Config file not generated"
            exit 1
          fi
          
          # Display and verify content
          cat ./.copilot_yolo.conf
          
          # Verify it has expected content
          if ! grep -q "copilot_yolo configuration file" ./.copilot_yolo.conf; then
            echo "Error: Config file has unexpected content"
            exit 1
          fi
          
          echo "✓ Config generation test passed"

  test-dry-run:
    name: Test Dry Run Mode
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Test Dry Run Output
        run: |
          set -e
          # Test dry run mode
          output=$(COPILOT_SKIP_UPDATE_CHECK=1 COPILOT_DRY_RUN=1 ./.copilot_yolo.sh --help 2>&1)
          
          # Verify dry run produces expected output
          if ! echo "$output" | grep -q "Dry run: would build image with:"; then
            echo "Error: Dry run output missing build message"
            exit 1
          fi
          
          if ! echo "$output" | grep -q "Dry run: would run:"; then
            echo "Error: Dry run output missing run message"
            exit 1
          fi
          
          if ! echo "$output" | grep -q "docker run"; then
            echo "Error: Dry run output missing docker run command"
            exit 1
          fi
          
          if ! echo "$output" | grep -q "copilot --yolo --help"; then
            echo "Error: Dry run output missing copilot command"
            exit 1
          fi
          
          echo "✓ Dry run test passed"
          echo ""
          echo "=== Dry run output ==="
          echo "$output"

  validate-version:
    name: Validate VERSION File
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check VERSION format
        run: |
          VERSION=$(cat VERSION | tr -d '\n ')
          echo "Version: ${VERSION}"
          
          # Check that version follows semver format (basic check)
          if [[ ! "${VERSION}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: VERSION file does not follow semver format (x.y.z)"
            exit 1
          fi

      - name: Enforce VERSION bump for runtime file changes
        run: |
          set -euo pipefail

          HEAD_SHA="${GITHUB_SHA:-$(git rev-parse HEAD)}"
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
          fi

          if [[ -z "${BASE_SHA}" || "${BASE_SHA}" == "0000000000000000000000000000000000000000" ]]; then
            if git rev-parse HEAD^ >/dev/null 2>&1; then
              BASE_SHA="$(git rev-parse HEAD^)"
            else
              echo "No previous commit available; skipping VERSION bump guard."
              exit 0
            fi
          fi

          if ! git cat-file -e "${BASE_SHA}^{commit}" 2>/dev/null; then
            echo "Warning: base commit ${BASE_SHA} is not available locally."
            echo "Skipping VERSION bump guard."
            exit 0
          fi

          changed_files="$(git diff --name-only "${BASE_SHA}" "${HEAD_SHA}")"
          echo "Changed files between ${BASE_SHA} and ${HEAD_SHA}:"
          echo "${changed_files}"

          runtime_pattern='^(\.copilot_yolo\.sh|\.copilot_yolo\.Dockerfile|\.copilot_yolo_entrypoint\.sh|\.copilot_yolo_config\.sh|\.copilot_yolo_completion\.bash|\.copilot_yolo_completion\.zsh|install\.sh|\.dockerignore)$'
          runtime_changed=0
          version_changed=0

          if echo "${changed_files}" | grep -Eq "${runtime_pattern}"; then
            runtime_changed=1
          fi

          if echo "${changed_files}" | grep -qx "VERSION"; then
            version_changed=1
          fi

          if [[ "${runtime_changed}" -eq 1 && "${version_changed}" -ne 1 ]]; then
            echo "Error: distributed runtime files changed without a VERSION bump."
            echo "If you modify runtime-distributed files, update VERSION in the same PR."
            exit 1
          fi

          echo "✓ VERSION guard passed"

name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  shellcheck:
    name: ShellCheck Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'
          severity: warning
          format: gcc
          additional_files: '.copilot_yolo.sh .copilot_yolo_entrypoint.sh .copilot_yolo_config.sh .copilot_yolo_logging.sh install.sh'

  test-docker-build:
    name: Test Docker Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Test Docker Image Build
        run: |
          docker buildx build \
            --build-arg BASE_IMAGE=node:20-slim \
            --build-arg COPILOT_VERSION=latest \
            --build-arg COPILOT_YOLO_VERSION=$(cat VERSION) \
            -t copilot-cli-yolo:test \
            -f .copilot_yolo.Dockerfile \
            .
      
      - name: Test Docker Image
        run: |
          docker run --rm copilot-cli-yolo:test copilot --version || true
          docker run --rm copilot-cli-yolo:test cat /opt/copilot-version
          docker run --rm copilot-cli-yolo:test cat /opt/copilot-yolo-version

  test-install-script:
    name: Test Install Script
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      
      - name: Test Install Script (Dry Run)
        run: |
          # Create a temporary directory for test installation
          TEST_DIR=$(mktemp -d)
          
          # Test the install script by installing to temp dir
          COPILOT_YOLO_DIR="${TEST_DIR}/.copilot_yolo" \
          COPILOT_YOLO_PROFILE="${TEST_DIR}/.bashrc" \
          bash install.sh
          
          # Verify files were created
          ls -la "${TEST_DIR}/.copilot_yolo/"
          
          # Verify the env file was created
          test -f "${TEST_DIR}/.copilot_yolo/env"
          
          # Verify completion files
          test -f "${TEST_DIR}/.copilot_yolo/.copilot_yolo_completion.bash" || echo "Warning: bash completion not found"
          test -f "${TEST_DIR}/.copilot_yolo/.copilot_yolo_completion.zsh" || echo "Warning: zsh completion not found"
          
          # Clean up
          rm -rf "${TEST_DIR}"

  test-health-check:
    name: Test Health Check Command
    runs-on: ubuntu-latest
    needs: test-docker-build
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Health Check
        run: |
          # Test health check without building (should warn about missing image)
          COPILOT_SKIP_VERSION_CHECK=1 COPILOT_SKIP_UPDATE_CHECK=1 \
            ./.copilot_yolo.sh health || true

  test-config-generation:
    name: Test Config Generation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate Sample Config
        run: |
          set -e
          # Generate config in installation directory
          COPILOT_SKIP_UPDATE_CHECK=1 COPILOT_SKIP_VERSION_CHECK=1 \
            ./.copilot_yolo.sh config
          
          # Verify config was generated in the script directory
          if [ ! -f ./.copilot_yolo.conf ]; then
            echo "Error: Config file not generated"
            exit 1
          fi
          
          # Display and verify content
          cat ./.copilot_yolo.conf
          
          # Verify it has expected content
          if ! grep -q "copilot_yolo configuration file" ./.copilot_yolo.conf; then
            echo "Error: Config file has unexpected content"
            exit 1
          fi
          
          echo "âœ“ Config generation test passed"

  validate-version:
    name: Validate VERSION File
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check VERSION format
        run: |
          VERSION=$(cat VERSION | tr -d '\n ')
          echo "Version: ${VERSION}"
          
          # Check that version follows semver format (basic check)
          if [[ ! "${VERSION}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: VERSION file does not follow semver format (x.y.z)"
            exit 1
          fi
